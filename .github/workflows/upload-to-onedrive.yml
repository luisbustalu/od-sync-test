name: Upload Files to OneDrive and Convert Markdown to PDF

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  upload-to-onedrive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch full history for accurate file detection
    
    - name: Validate folder mapping
      run: |
        if [ ! -f "folder-mapping.yml" ]; then
          echo "âŒ folder-mapping.yml not found!"
          echo "Please create a folder-mapping.yml file in the root of your repository."
          exit 1
        fi
        echo "âœ… folder-mapping.yml found"
    
    - name: Extract mapped folders
      id: mapped-folders
      run: |
        # Use Python to properly parse YAML and extract folder names
        MAPPED_FOLDERS=$(python3 -c "
        import yaml
        import re
        import sys
        
        try:
            with open('folder-mapping.yml', 'r') as f:
                config = yaml.safe_load(f)
            
            if 'mappings' in config:
                folders = list(config['mappings'].keys())
                # Escape special regex characters for each folder name
                escaped_folders = []
                for folder in folders:
                    # Escape regex special characters
                    escaped = re.escape(folder)
                    escaped_folders.append(escaped)
                
                # Join with | for regex alternation
                result = '|'.join(escaped_folders)
                print(result)
            else:
                print('No mappings found in folder-mapping.yml', file=sys.stderr)
                sys.exit(1)
        except Exception as e:
            print(f'Error parsing folder-mapping.yml: {e}', file=sys.stderr)
            sys.exit(1)
        ")
        
        echo "Mapped folders: $MAPPED_FOLDERS"
        echo "mapped-folders=$MAPPED_FOLDERS" >> $GITHUB_OUTPUT
    
    - name: Check for changed files in mapped folders
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          # For push events, check files changed in the last commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || true)
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          # For PR events, check files changed compared to base branch
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD || true)
        else
          # For manual dispatch, upload all files in mapped folders
          MAPPED_FOLDERS="${{ steps.mapped-folders.outputs.mapped-folders }}"
          CHANGED_FILES=$(find . -type f | grep -E "^\./($MAPPED_FOLDERS)/" | grep -v node_modules | grep -v .git || true)
        fi
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No files changed in mapped folders"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          # Filter to only include files in mapped folders
          MAPPED_FOLDERS="${{ steps.mapped-folders.outputs.mapped-folders }}"
          FILTERED_FILES=$(echo "$CHANGED_FILES" | grep -E "^($MAPPED_FOLDERS)/" || true)
          
          if [ -z "$FILTERED_FILES" ]; then
            echo "No files changed in mapped folders"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Changed files in mapped folders:"
            echo "$FILTERED_FILES"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: Setup Node.js
      if: steps.changed-files.outputs.skip == 'false'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      if: steps.changed-files.outputs.skip == 'false'
      run: npm ci
    
    - name: Install pandoc and LaTeX
      if: steps.changed-files.outputs.skip == 'false'
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-latex-base texlive-latex-extra texlive-latex-recommended texlive-fonts-recommended texlive-fonts-extra texlive-lang-english texlive-luatex
    
    - name: Upload to OneDrive
      if: steps.changed-files.outputs.skip == 'false'
      env:
        ONEDRIVE_CLIENT_ID: ${{ secrets.ONEDRIVE_CLIENT_ID }}
        ONEDRIVE_CLIENT_SECRET: ${{ secrets.ONEDRIVE_CLIENT_SECRET }}
        ONEDRIVE_REFRESH_TOKEN: ${{ secrets.ONEDRIVE_REFRESH_TOKEN }}
      run: node upload-to-onedrive.js
    
    - name: Upload Summary
      if: steps.changed-files.outputs.skip == 'false'
      run: |
        echo "## ðŸ“„ OneDrive Upload Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Files in mapped folders have been successfully uploaded to OneDrive based on the folder mappings." >> $GITHUB_STEP_SUMMARY
        echo "Markdown files have also been converted to PDF and uploaded." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Mapped Folders**: ${{ steps.mapped-folders.outputs.mapped-folders }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify if skipped
      if: steps.changed-files.outputs.skip == 'true'
      run: |
        echo "## â„¹ï¸ Upload Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "No files were changed in mapped folders, so the OneDrive upload was skipped." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Mapped folders**: ${{ steps.mapped-folders.outputs.mapped-folders }}" >> $GITHUB_STEP_SUMMARY